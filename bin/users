#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path('../../lib', __FILE__)
$stdout.sync = true

require 'bundler/setup'

require 'active_record'
require "stringio"
require 'travis/config'

# Temp redirect of output
def silence(&block)
  previous_stdout, $stdout = $stdout, StringIO.new
  previous_stderr, $stderr = $stderr, StringIO.new
  block.call
ensure
  $stdout = previous_stdout
  $stderr = previous_stderr
end

# Setup app (can we simplify this?)
c = ActiveRecord::Base.establish_connection(Travis::Config.load.database.to_h)
class User < ActiveRecord::Base
  scope :active,    -> { where('github_oauth_token IS NOT NULL AND suspended = false') }
  scope :inactive,  -> { where('github_oauth_token IS NULL AND suspended = false') }
  scope :suspended, -> { where(suspended: true) }
  scope :alpha,     -> { order(login: :asc) }

  def enterprise_status
    case
    when suspended
      "Suspended #{suspended_at.strftime('%F')}"
    when !github_oauth_token
      'Inactive'
    else
      'Active'
    end
  end
end
# Triggers autoloading of pg gem, which has deprecation warnings at v0.21.0
silence { User.connection }

option = ARGV.first
users = if option == '--active'
  User.active.alpha
elsif option == '--inactive'
  User.inactive.alpha
elsif option == '--suspended'
  User.suspended.alpha
elsif [nil, '--all'].include?(option)
  User.all.alpha
else
  puts "Option #{option} not recognised." and exit 1
end

if users
  col_width = users.pluck(:login).map(&:length).max
  users.each do |user|
    puts [user.login.ljust(col_width), user.enterprise_status.ljust(col_width)].join(' ' * 5)
  end
  exit 0
end
