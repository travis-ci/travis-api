#!/usr/bin/env ruby

$stdout.sync = true

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'bundler/setup'
require 'travis/api/app'
require 'travis/api/v3/models/user'

# Setup app (can we simplify this?)
Travis::Api::App.new
V3 = Travis::API::V3

option = ARGV[1]
users = if option == '--active'
  V3::Models::User.where('github_oauth_token IS NOT NULL AND suspended = false').order(login: :asc)
elsif option == '--suspended'
  V3::Models::User.where(suspended: true).order(login: :asc)
elsif option == nil
  V3::Models::User.all.order(login: :asc)
else
  puts "Option #{option} not recognised." and exit 1
end

if users
  col_width = users.pluck(:login).map(&:length).max
  users.each do |user|
    puts [
      user.login.ljust(col_width),
      (user.suspended? ? "Suspended at #{user.suspended_at.strftime('%F')}" : '').ljust(col_width)
    ].join(' ' * 5)
  end
  exit 0
end
