#!/bin/bash

set -e

function usage() {
  echo "Encodes the provided files via a RubyEncoder instance running on the te-encode.travis-ci.com server"
  echo
  echo "This script assumes you have set up the following ENV vars:"
  echo "  - RUBYENCODER_PROJECT_ID"
  echo "  - RUBYENCODER_PROJECT_KEY"

  exit 1
}

echo
echo "Starting run for `basename "$0"` ..."
echo

if [[ -z $RUBYENCODER_PROJECT_ID ]]; then
  echo "ERROR: $RUBYENCODER_PROJECT_ID not set, exiting ..."
  usage
fi

if [[ -z $RUBYENCODER_PROJECT_KEY ]]; then
  echo "ERROR: $RUBYENCODER_PROJECT_KEY not set, exiting ..."
  usage
fi

mkdir -p /root/.ssh
chmod 0700 /root/.ssh
echo "$SSH_KEY" > /root/.ssh/id_rsa
chmod 400 /root/.ssh/id_rsa

shopt -s extglob globstar nullglob
paths=$(find /app/{config,app,lib,db}/**/*.rb -type f 2>/dev/null)
shopt -u extglob globstar nullglob

ssh_target=root@te-encode.travis-ci.com
ssh_opts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=error"
ssh_cmd='
  dir=$(mktemp -d)
  trap "rm -r $dir" EXIT
  cd $dir
  tar xzm
  rubyencoder -b- --ruby 2.5 --projid="'$RUBYENCODER_PROJECT_ID'" --projkey="'$RUBYENCODER_PROJECT_KEY'" $(find . -type f) 1>&2
  if [ $? -eq 0 ]; then tar cz *; else exit 1; fi
'

echo "Encoding $(echo "$paths" | wc -w) files on ${ssh_target#*@}"
tar cz $paths | ssh $ssh_target $ssh_opts "$ssh_cmd" | tar xzm
rc=$?

echo
echo "`basename "$0"` completed with rc=$rc"
exit $rc