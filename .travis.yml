language: ruby
rvm: '2.5.5'
cache: bundler
dist: bionic
env:
  global:
    - PATH=/snap/bin:$PATH
addons:
  postgresql: 9.6
services:
  - redis
before_install:
  - 'gem install bundler -v 2.1.4'
before_script:
  - cp config/travis.example.yml config/travis.yml
  - "createdb travis_test || true"
  - "curl -fs https://raw.githubusercontent.com/travis-ci/travis-migrations/master/db/main/structure.sql | psql travis_test"
script: RAILS_ENV=test bundle exec rake spec
jobs:
  include:
    - stage: ":ship: it to Quay.io"
      addons:
        snaps:
        - name: docker
          channel: latest/beta
      install: echo skip
      before_script: echo skip
      script: make ship
      if: commit_message =~ /ship:docker/ OR env(SHIP_DOCKER) = true or branch = master