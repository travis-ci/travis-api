require 'sentry-raven'

describe 'Exception', set_app: true do
  class FixRaven < Struct.new(:app)
    def call(env)
      requested_at = env['requested_at']
      env['requested_at'] = env['requested_at'].to_s if env.key?('requested_at')
      app.call(env)
    rescue Exception => e
      env['requested_at'] = requested_at
      raise e
    end
  end

  class TestError < StandardError
  end

  before do
    Raven.configure do |config|
      config.silence_ready = true
    end

    set_app Raven::Rack.new(FixRaven.new(app))
    Travis.config.sentry.dsn = 'https://fake:token@app.getsentry.com/12345'
    Travis::Api::App.setup_monitoring
    Travis.testing = false

    allow(Raven).to receive(:send_event)
  end

  after do
    Travis.testing = true
  end

  it 'raises an error in testing mode' do
    begin
      Travis.testing = false

      error = TestError.new('a test error')
      allow_any_instance_of(Travis::Api::App::Endpoint::Repos).to receive(:service).and_raise(error)
      res = get '/repos/1', nil, 'HTTP_X_REQUEST_ID' => '235dd08f-10d5-4fcc-9a4d-6b8e6a24f975'
    rescue TestError => e
      expect(e.message).to eq('a test error')
    ensure
      Travis.testing = true
    end
  end

  before do
    stub_request(:post, "https://app.getsentry.com/api/12345/store/").
      with(
        body: "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",
        headers: {
          'Accept'=>'*/*',
          'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
          'Content-Type'=>'application/octet-stream',
          'User-Agent'=>'sentry-ruby/3.0.4',
          'X-Sentry-Auth'=>'Sentry sentry_version=5, sentry_client=raven-ruby/3.0.4, sentry_timestamp=1644887612, sentry_key=fake, sentry_secret=token'
        }).
      to_return(status: 200, body: "", headers: {})
  end

  it 'enqueues error into a thread' do
    error = TestError.new('Konstantin broke all the thingz!')
    allow_any_instance_of(Travis::Api::App::Endpoint::Repos).to receive(:service).and_raise(error)
    expect(Raven).to receive(:send_event).with(
      satisfy do |event|
        event_error = event['exception']['values'].first
        event_error['type'] == error.class.to_s && event_error['value'] == error.message
      end
    )
    res = get '/repos/1'
    expect(res.status).to eq(500)
    expect(res.body).to eq("Sorry, we experienced an error.\n")
    expect(res.headers).to eq({
      'Content-Type' => 'text/plain',
      'Content-Length' => '32',
      'Access-Control-Allow-Origin' => '*',
      'Access-Control-Allow-Credentials' => 'true',
      'Access-Control-Expose-Headers' => 'Content-Type, Cache-Control, Expires, Etag, Last-Modified, X-Request-ID',
    })
    sleep 0.1
  end

  it 'returns request_id in body' do
    error = TestError.new('Konstantin broke all the thingz!')
    allow_any_instance_of(Travis::Api::App::Endpoint::Repos).to receive(:service).and_raise(error)
    allow(Raven).to receive(:send_event)
    res = get '/repos/1', nil, 'HTTP_X_REQUEST_ID' => '235dd08f-10d5-4fcc-9a4d-6b8e6a24f975'
    expect(res.status).to eq(500)
    expect(res.body).to eq("Sorry, we experienced an error.\n\nrequest_id:235dd08f-10d5-4fcc-9a4d-6b8e6a24f975\n")
    expect(res.headers).to eq({
      'Content-Type' => 'text/plain',
      'Content-Length' => '81',
      'X-Request-ID' => '235dd08f-10d5-4fcc-9a4d-6b8e6a24f975',
      'Access-Control-Allow-Origin' => '*',
      'Access-Control-Allow-Credentials' => 'true',
      'Access-Control-Expose-Headers' => 'Content-Type, Cache-Control, Expires, Etag, Last-Modified, X-Request-ID',
    })
    sleep 0.1
  end
end
