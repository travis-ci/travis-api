<section class="info-block">
  <h2 class="info-header">Basic information</h2>
  <% unless travis_config.enterprise? %>
    <% if @user.travis_admin? %>
      <p>This user has <%= link_to "admin access", admins_path %>.</p>
    <% end %>
  <% end %>

  <dl class="simple-info">
    <dt class="info-label">Name</dt>
    <dd class="inline become">
      <p><%= @user.name %></p>
      <% unless travis_config.enterprise? %>
        <div>
          <%= form_tag(become_url(@user), class: 'become-button') do %>
            <%= hidden_field_tag(:sso_token, access_token(current_user)) %>
            <%= submit_tag("Log in as", class: "button") %>
          <% end %>
          <%= form_tag("#{become_url(@user)}?billing=true", class: 'billing-button') do %>
            <%= hidden_field_tag(:sso_token, access_token(current_user)) %>
            <%= submit_tag("Billing", class: "button") %>
          <% end %>
        </div>
      <% end %>
    </dd>

    <dt class="info-label">GitHub login</dt>
    <dd>
      <%= image_tag(@user.avatar_url, size: "20x20", alt: "Avatar", class: "avatar") if @user.avatar_url %>
      <%= @user.login %>
      <%= link_to fa_icon("github"), "https://github.com/#{@user.login}", target: "_blank" %>
    </dd>

    <dt class="info-label">GitHub ID</dt>
    <dd><%= @user.github_id %></dd>

    <dt class="info-label">Token</dt>
    <dd class="inline">
      <% if @display_gh_token %>
        <pre><%= @user.github_oauth_token %></pre>
        <%= button_to 'Hide', hide_token_user_path(@user), class: 'button', form_class: 'hide_gh_token' %>
      <% else %>
        <%= hidden(@user, :github_oauth_token) %>
        <%= form_tag({action: 'display_token', controller: "users", id: @user.id, method: 'post'}, {class: 'display_gh_token'}) do %>
          <%= render partial: "shared/otp" %>
          <%= submit_tag 'Display', class: 'button otp', id: "display_gh_token" %>
        <% end %>
      <% end %>
    </dd>

    <dt class="info-label">Scopes</dt>
    <dd>
      <% if @user.github_scopes.present? %>
        <%= @user.github_scopes %>
      <% else %>
        none
      <% end %>
    </dd>

    <dt class="info-label">Last sync</dt>
    <dd class="inline">
      <p>
        <% if @user.is_syncing? %>
          Currently syncing
        <% else %>
          <%= @user.synced_at ? @user.synced_at : "Never" %>
        <% end %>
      </p>
      <%= button_to 'Sync', sync_user_path(@user), disabled: @user.is_syncing?, form_class: "sync-button", class: 'button' %>
    </dd>
     <% if travis_config.enterprise? %>
      <dt class="info-label">Enterprise Status</dt>
      <dd class="inline">
        <p>
          <%= @user.enterprise_status %>
          <% if @user.suspended? %>
            <div class="call-to-action"><%= button_to "Unsuspend", unsuspend_user_path(@user), class: "button", data: { disable_with: 'Loading' } %>
          <% else %>
            <div class="call-to-action"><%= button_to "Suspend", suspend_user_path(@user), class: "button", data: { disable_with: 'Loading' } %>
          <% end %>
        </p>
      </dd>
    <% end %>
  </dl>
</section>

<% unless travis_config.enterprise? %>
  <%= render partial: 'shared/account', locals: {owner: @user} %>
<% end %>

<section class="info-block">
  <h2 class="info-header">Contact information</h2>
  <dl class="simple-info">
    <dt class="info-label">Primary e-mail address</dt>
    <dd>
      <%= @user.email %>
      <%= mail_to @user.email, fa_icon("envelope-o") %>
    </dd>

    <dt class="info-label">Additional e-mail addresses</dt>
    <dd>
      <% @user.emails.each do |entry| %>
        <% if entry.email != @user.email %>
          <div>
            <%= entry.email %>
            <%= mail_to entry.email, fa_icon("envelope-o") %>
          </div>
        <% end %>
      <% end %>
    </dd>
  </dl>
</section>

<section class="abuse">
  <h2 class="info-header">Abuse</h2>
  <dl>
    <%= form_tag(users_abuse_detections_path(@user), method: :put) do %>
      <%= hidden_field_tag 'abuse_id', @user.id %>
      <dd>
        <%= check_box_tag "abuse_trusted", 1, checked = Travis::DataStores.redis.sismember("abuse:trusted", params[:abuse_id]) %>
        <%= label_tag 'Trusted account' %>
      </dd>
      <dd>
        <%= check_box_tag "abuse_offenders", 1, checked = Travis::DataStores.redis.sismember("abuse:offenders", params[:abuse_id]) %>
        <%= label_tag 'Known offender' %>
        <%= text_field_tag "abuse_reason", nil, placeholder: 'Optional reason' %>
      </dd>
      <dd>
        <%= check_box_tag "abuse_not_fishy", 1, checked = Travis::DataStores.redis.sismember("abuse:not_fishy", params[:abuse_id]) %>
        <%= label_tag 'Not fishy' %>
      </dd>
      <dt>
        <%= submit_tag("Update", class: "button") %>
      </dt>
    <% end %>
    <dt class="info-label">Reasons</dt>
    <dd>
      <% @user.abuses.each do |abuse| %>
        <span>
          Marked <%= abuse_name(abuse) %>
          <% if abuse.request_id.present? %>
            <%= link_to 'for this request', request_path(abuse.request_id) %>
          <% end %>
          . Explanation: <%= abuse.reason %> <%= abuse.created_at %>
        </span>
        <br>
      <% end %>
    </dd>
  </dl>
</section>

