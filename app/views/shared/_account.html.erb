<section class="info-block">
  <h2 class="info-header">Account information</h2>

  <dl class="simple-info">
    <dt class="info-label">Travis ID</dt>
    <dd><%= owner.id %></dd>

    <dt class="info-label">Account creation</dt>
    <dd>
      <time>
        <%= owner.created_at %>
      </time>
    </dd>


    <dt class="info-label">Trial</dt>
    <dd>
      <% if owner.latest_trial %>
        <ul style="margin: 0;">
        <% owner.latest_trial.trial_allowances.each do |ta| %>
          <li><%= "%d builds added by %s %s" % [ta.builds_allowed, ta.creator.name, ta.created_at] %></li>
        <% end %>
        </ul>
        <%= form_tag update_trial_builds_path(owner) do %>
          <%= number_field_tag :builds_allowed, '', min: '1', max: '500' %>
          <%= submit_tag 'Add' %>
        <% end %>
      <% else %>
        None.
      <% end %>
    </dd>

    <dt class="info-label">Subscription</dt>
    <dd class="inline">
      <p>
        <% if owner.subscription %>
          <a href='#subscription'><%=format_subscription(owner.subscription) %></a>
        <% else %>
          None.
        <% end %>
      </p>

      <% unless owner.subscription && owner.subscription.active? %>
        <%= form_for :subscription, url: {controller: 'subscriptions', action: 'create'}, html: {class: 'create-subscription'} do |f| %>
          <%= f.hidden_field :owner_type, value: owner.class %>
          <%= f.hidden_field :owner_id, value: owner.id %>
          <%= f.select(:selected_plan) do %>
            <% [['one build', 'travis-ci-one-build'], ['two builds', 'travis-ci-two-builds']].each do |c| -%>
              <%= content_tag(:option, c.first, value: c.last) %>
            <% end %>
          <% end %>
          <%= f.submit 'Create Free', class: 'button', id: 'create-subscription' %>
        <% end %>
      <% end %>
    </dd>

    <% if @last_build %>
      <dt class="info-label">Last build</dt>
      <dd>
        <%= link_to describe(@last_build), @last_build %>
      </dd>
    <% end %>

    <dt class="info-label">Boost jobs</dt>
    <dd>
      <%= form_for :boost, url: {action: 'boost', controller: "#{owner.class.table_name}"}, html: {class: 'job-boost inline'} do |f| %>
        <div>
          <%= f.label :owner_limit, "Limit" %>
          <%= f.text_field :owner_limit, value: @existing_boost_limit %>
          <%= f.label :expires_after, "Expires in (hours)" %>
          <%= f.text_field :expires_after, value: @normalized_boost_time %>
        </div>
        <%= f.submit 'Update', class: 'button', id: 'update-job-boost' %>
      <% end %>
    </dd>
  </dl>
</section>

<div class="break"></div>

<section class="info-block">
  <h2 class="info-header">Feature flags</h2>
  <%= render partial: 'shared/features_for', locals: {owner: owner} %>
</section>

<section class="info-block">
  <h2 class="info-header">Abuse</h2>
  <%= form_for :offender, url: { controller: "offenders", action: "update", login: owner.login}, html: {class: "abuse-form inline" }, method: :put do |f| %>
    <div>
      <dl>
        <dd>
          <%= f.check_box :trusted, checked: trusted?(owner) %>
          <%= f.label 'Trusted account' %>
        </dd>
        <dd>
          <%= f.check_box :offenders, checked: offender?(owner) %>
          <%= f.label 'Known offender' %>
          <%= f.text_field :reason, placeholder: 'Optional Reason' %>
        </dd>
        <dd>
          <%= f.check_box :not_fishy, checked: not_fishy?(owner) %>
          <%= f.label 'Not fishy' %>
        </dd>
      </dl>
    </div>
    <%= f.submit('Update', class: 'button', id: 'update-abuse-status') %>
  <% end %>
  <% if owner.abuses.any? %>
    <div class="abuse-reasons">
      <dt class="info-label">Reasons</dt>
      <dd>
        <% owner.abuses.each do |abuse| %>
        <span>
          Marked <%= abuse_name(abuse) %>
          <% if abuse.request_id.present? %>
            <%= link_to 'for this request', request_path(abuse.request_id) %>
          <% end %>
          . Explanation: <%= abuse.reason %> <%= abuse.created_at %>
        </span>
          <br>
        <% end %>
      </dd>
    </div>
  <% end %>
</section>
